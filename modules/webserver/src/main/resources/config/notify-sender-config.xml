<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:c="http://www.springframework.org/schema/c"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="springMailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
        <property name="host" value="${mail.server.host}"/>
        <property name="port" value="${mail.server.port}"/>
        <property name="username" value="${mail.server.username}"/>
        <property name="password" value="${mail.server.password}"/>

        <property name="javaMailProperties">
            <props>
                <prop key="mail.smtp.auth">${mail.server.auth}</prop>
            </props>
        </property>
    </bean>

    <bean id="notificationExecutorService" class="java.util.concurrent.Executors"
          factory-method="newSingleThreadExecutor">
        <constructor-arg index="0">
            <bean class="org.springframework.scheduling.concurrent.CustomizableThreadFactory">
                <property name="threadNamePrefix" value="MailNotificationManager"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="notificationFreemarkerConfig" parent="commonFreemarkerConfig" scope="prototype">
        <property name="preferFileSystemAccess" value="false"/>
        <property name="templateLoaderPath" value="classpath:/i18n/notify"/>
        <property name="freemarkerVariables">
            <map merge="true">
                <entry key="serverHostName" value="${server.hostname}"/>
                <entry key="ratingManager" value-ref="ratingManager"/>
            </map>
        </property>
    </bean>

    <bean id="notificationTransformer"
          class="wisematches.server.web.services.notify.impl.transform.FreeMarkerNotificationTransformer">
        <property name="messageSource" ref="messageSource"/>
        <property name="freeMarkerConfig">
            <bean factory-bean="notificationFreemarkerConfig" factory-method="createConfiguration"/>
        </property>
    </bean>

    <bean id="mailNotificationPublisher"
          class="wisematches.server.web.services.notify.impl.publish.mail.MailNotificationPublisher">
        <property name="mailSender" ref="springMailSender"/>
        <property name="messageSource" ref="messageSource"/>
        <property name="serverHostName" value="${server.hostname}"/>
        <property name="executorService" ref="notificationExecutorService"/>
        <property name="transactionTemplate" ref="transactionRequiresNew"/>
        <property name="notificationTransformer" ref="notificationTransformer"/>
    </bean>

    <bean id="messageNotificationPublisher"
          class="wisematches.server.web.services.notify.impl.publish.message.MessageNotificationPublisher">
        <property name="messageManager" ref="messageManager"/>
        <property name="executorService" ref="notificationExecutorService"/>
        <property name="notificationTransformer" ref="notificationTransformer"/>
        <property name="transactionRequiresNew" ref="transactionRequiresNew"/>
    </bean>

    <bean id="notification" class="wisematches.server.web.services.notify.NotificationDescription"
          abstract="true"/>

    <bean id="notificationManager"
          class="wisematches.server.web.services.notify.impl.manager.HibernateNotificationManager">
        <property name="sessionFactory" ref="sessionFactory"/>
        <property name="notificationDescription">
            <list>
                <bean parent="notification" c:name="game.state.started"
                      c:group="games" c:enabled="true" c:evenOnline="false"/>

                <bean parent="notification" c:name="game.state.finished"
                      c:group="games" c:enabled="true" c:evenOnline="true"/>

                <bean parent="notification" c:name="game.move.your"
                      c:group="games" c:enabled="true" c:evenOnline="false" c:series="game.move"/>

                <bean parent="notification" c:name="game.move.opponent"
                      c:group="games" c:enabled="false" c:evenOnline="false" c:series="game.move"/>

                <bean parent="notification" c:name="game.timeout.day"
                      c:group="expiration" c:enabled="true" c:evenOnline="false"/>

                <bean parent="notification" c:name="game.timeout.half"
                      c:group="expiration" c:enabled="true" c:evenOnline="false"/>

                <bean parent="notification" c:name="game.timeout.hour"
                      c:group="expiration" c:enabled="true" c:evenOnline="true"/>

                <bean parent="notification" c:name="game.challenge.received"
                      c:group="challenge" c:enabled="true" c:evenOnline="false" c:series="game.challenge"/>

                <bean parent="notification" c:name="game.challenge.rejected"
                      c:group="challenge" c:enabled="false" c:evenOnline="false" c:series="game.challenge"/>

                <bean parent="notification" c:name="game.message"
                      c:group="message" c:enabled="true" c:evenOnline="false" c:series="game.message"/>
            </list>
        </property>
    </bean>

    <bean id="notificationPublisherCenter"
          class="wisematches.server.web.services.notify.impl.NotificationPublisherCenter">
        <property name="playerManager" ref="playerManager"/>
        <property name="boardManager" ref="scribbleBoardManager"/>
        <property name="proposalManager" ref="scribbleProposalManager"/>
        <property name="expirationManager" ref="scribbleTerminator"/>
        <property name="notificationPublisher">
            <list>
                <bean class="wisematches.server.web.services.notify.impl.publish.reducer.FilteringNotificationPublisher">
                    <property name="acceptedNotifications">
                        <set>
                            <value>game.state.finished</value>
                            <value>game.challenge.received</value>
                            <value>game.challenge.rejected</value>
                        </set>
                    </property>
                    <property name="notificationPublisher" ref="messageNotificationPublisher"/>
                </bean>

                <bean class="wisematches.server.web.services.notify.impl.publish.reducer.ReducingNotificationPublisher">
                    <property name="playerStateManager" ref="playerStateManager"/>
                    <property name="notificationManager" ref="notificationManager"/>
                    <property name="notificationPublisher" ref="mailNotificationPublisher"/>
                </bean>
            </list>
        </property>
    </bean>
</beans>