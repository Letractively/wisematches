<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:c="http://www.springframework.org/schema/c" xmlns:p="http://www.springframework.org/schema/p"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="springMailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
        <property name="host" value="${mail.server.host}"/>
        <property name="port" value="${mail.server.port}"/>
        <property name="username" value="${mail.server.username}"/>
        <property name="password" value="${mail.server.password}"/>

        <property name="javaMailProperties">
            <props>
                <prop key="mail.smtp.auth">${mail.server.auth}</prop>
            </props>
        </property>
    </bean>

    <bean id="notificationTaskExecutor" class="org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler">
        <property name="poolSize" value="1"/>
        <property name="threadNamePrefix" value="NotificationManager"/>
        <property name="waitForTasksToCompleteOnShutdown" value="true"/>
    </bean>

    <bean id="notificationFreemarkerConfigurer" parent="commonFreemarkerConfigurer" scope="prototype">
        <property name="preferFileSystemAccess" value="false"/>
        <property name="templateLoaderPath" value="classpath:/i18n/notify"/>
        <property name="freemarkerVariables">
            <map merge="true">
                <entry key="serverHostName" value="${server.hostname}"/>
                <entry key="ratingManager" value-ref="ratingManager"/>
            </map>
        </property>
    </bean>

    <bean id="notificationFreemarkerConfig"
          factory-bean="notificationFreemarkerConfigurer" factory-method="createConfiguration"/>


    <bean id="notificationTransformer"
          class="wisematches.server.web.services.notify.impl.transform.FreeMarkerNotificationTransformer">
        <property name="messageSource" ref="messageSource"/>
        <property name="freeMarkerConfig" ref="notificationFreemarkerConfig"/>
    </bean>

    <bean id="mailNotificationTransport"
          class="wisematches.server.web.services.notify.impl.transport.MailNotificationTransport">
        <property name="hostName" value="${server.hostname}"/>
        <property name="mailSender" ref="springMailSender"/>
        <property name="messageSource" ref="messageSource"/>
    </bean>

    <bean id="messageNotificationTransport"
          class="wisematches.server.web.services.notify.impl.transport.MessageNotificationTransport">
        <property name="messageManager" ref="messageManager"/>
    </bean>

    <bean id="mailNotificationPublisher"
          class="wisematches.server.web.services.notify.impl.publisher.DefaultNotificationPublisher">
        <property name="transport" ref="mailNotificationTransport"/>
        <property name="transformer">
            <bean class="wisematches.server.web.services.notify.impl.transform.OpenSessionNotificationTransformer">
                <property name="sessionFactory" ref="sessionFactory"/>
                <property name="notificationTransformer">
                    <bean parent="notificationTransformer" p:layoutTemplate="layoutMail.ftl"/>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="messageNotificationPublisher"
          class="wisematches.server.web.services.notify.impl.publisher.DefaultNotificationPublisher">
        <property name="transport" ref="mailNotificationTransport"/>
        <property name="transformer">
            <bean class="wisematches.server.web.services.notify.impl.transform.OpenSessionNotificationTransformer">
                <property name="sessionFactory" ref="sessionFactory"/>
                <property name="notificationTransformer">
                    <bean parent="notificationTransformer" p:layoutTemplate="layoutMessage.ftl"/>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="notification" class="wisematches.server.web.services.notify.NotificationDescriptor" abstract="true"/>

    <bean id="notificationManager"
          class="wisematches.server.web.services.notify.impl.manager.HibernateNotificationManager">
        <property name="sessionFactory" ref="sessionFactory"/>
        <property name="notificationDescriptors">
            <list>
                <bean parent="notification" c:code="account."
                      c:group="account" c:enabled="true"/>

                <bean parent="notification" c:code="playground.game.started"
                      c:group="game.state" c:enabled="true"/>

                <bean parent="notification" c:code="playground.game.turn.your"
                      c:group="game.state" c:enabled="true"
                      c:template="playground.game.turn"/>

                <bean parent="notification" c:code="playground.game.turn.opponent"
                      c:group="game.state" c:enabled="false"
                      c:template="playground.game.turn"/>

                <bean parent="notification" c:code="playground.game.finished"
                      c:group="game.state" c:enabled="true"/>


                <bean parent="notification" c:code="playground.game.expiration.day"
                      c:group="game.expiration" c:enabled="true"
                      c:template="playground.game.expiration"/>

                <bean parent="notification" c:code="playground.game.expiration.half"
                      c:group="game.expiration" c:enabled="true"
                      c:template="playground.game.expiration"/>

                <bean parent="notification" c:code="playground.game.expiration.hour"
                      c:group="game.expiration" c:enabled="true"
                      c:template="playground.game.expiration"/>


                <bean parent="notification" c:code="playground.proposal.initiated"
                      c:group="proposal.state" c:enabled="true"/>

                <bean parent="notification" c:code="playground.proposal.rejected"
                      c:group="proposal.state" c:enabled="true"
                      c:template="playground.proposal.finalized"/>

                <bean parent="notification" c:code="playground.proposal.repudiated"
                      c:group="proposal.state" c:enabled="true"
                      c:template="playground.proposal.finalized"/>

                <bean parent="notification" c:code="playground.proposal.terminated"
                      c:group="proposal.state" c:enabled="false"
                      c:template="playground.proposal.finalized"/>


                <bean parent="notification" c:code="playground.proposal.expiration.days"
                      c:group="proposal.expiration" c:enabled="true"
                      c:template="playground.proposal.expiration"/>

                <bean parent="notification" c:code="playground.proposal.expiration.day"
                      c:group="proposal.expiration" c:enabled="true"
                      c:template="playground.proposal.expiration"/>


                <bean parent="notification" c:code="playground.message.received"
                      c:group="playground.message" c:enabled="true"/>
            </list>
        </property>
    </bean>

    <bean id="notificationDistributor"
          class="wisematches.server.web.services.notify.impl.distributor.DefaultNotificationDistributor">
        <property name="taskExecutor" ref="notificationTaskExecutor"/>
        <property name="notificationManager" ref="notificationManager"/>

        <property name="unimpededPublishers">
            <bean id="asd" class="wisematches.server.web.services.notify.impl.publisher.MatchingNotificationPublisher">
                <property name="notificationPublisher" ref="messageNotificationPublisher"/>
                <property name="allowedNotifications">
                    <set>
                        <value>playground.game.finished</value>
                        <value>playground.proposal.initiated</value>
                        <value>playground.proposal.rejected</value>
                        <value>playground.proposal.terminated</value>
                    </set>
                </property>
            </bean>
        </property>

        <property name="customizablePublishers">
            <bean id="qwe"
                  class="wisematches.server.web.services.notify.impl.publisher.ReducingNotificationPublisher">
                <property name="groupedNotifications">
                    <map>
                        <entry key="playground.game.turn.your" value="playground.game.turn"/>
                        <entry key="playground.game.turn.opponent" value="playground.game.turn"/>
                    </map>
                </property>
                <property name="stateIndependentNotifications">
                    <set>
                        <value>playground.game.finished</value>
                        <value>playground.game.expiration.hour</value>
                    </set>
                </property>
                <property name="playerStateManager" ref="playerStateManager"/>
                <property name="notificationPublisher" ref="mailNotificationPublisher"/>
            </bean>
        </property>
    </bean>
    <bean class="wisematches.server.web.services.notify.impl.publisher.ReducingNotificationPublisher"
          id="reducingNotificationPublisher">
        <property name="taskExecutor" ref="notificationTaskExecutor"/>
    </bean>
    <!--

        <bean id="notificationPublisherCenter"
              class="wisematches.server.web.services.notify.impl.NotificationPublisherCenter">
            <property name="playerManager" ref="playerManager"/>
            <property name="boardManager" ref="scribbleBoardManager"/>
            <property name="proposalManager" ref="scribbleProposalManager"/>
            <property name="notificationDistributor" ref="notificationDistributor"/>
            <property name="scribbleExpirationManager" ref="scribbleGameExpirationManager"/>
            <property name="proposalExpirationManager" ref="scribbleProposalExpirationManager"/>
        </bean>
    -->
</beans>