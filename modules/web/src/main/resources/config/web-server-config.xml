<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

    <import resource="classpath:/config/game-scribble-config.xml"/>

    <bean id="webSessionFactory" parent="modulesSessionFactory">
        <property name="annotatedClasses">
            <list merge="true">
                <value>wisematches.server.web.modules.login.tokens.AbstractToken</value>
                <value>wisematches.server.web.modules.login.tokens.RememberToken</value>
                <value>wisematches.server.web.modules.login.tokens.RestoreToken</value>
                <value>wisematches.server.web.modules.core.problems.ProblemsReport</value>
                <value>wisematches.server.web.modules.app.playboard.memory.MemoryWordDo</value>
            </list>
        </property>
    </bean>

    <bean id="springMailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
        <property name="host" value="${server.mail.host}"/>
        <property name="port" value="${server.mail.port}"/>
        <property name="username" value="${server.mail.username}"/>
        <property name="password" value="${server.mail.password}"/>

        <property name="javaMailProperties">
            <props>
                <prop key="mail.smtp.auth">${server.mail.auth}</prop>
            </props>
        </property>
    </bean>

    <bean id="defaultMailSender" class="wisematches.server.web.mail.impl.MailSenderImpl">
        <property name="teamAddresses">
            <map>
                <entry key="BUGS_TEAM" value="smklimenko@gmail.com"/>
                <entry key="PROBLEMS_TEA" value="smklimenko@gmail.com"/>
                <entry key="SUPPORT_TEAM" value="smklimenko@gmail.com"/>
            </map>
        </property>

        <property name="templateParameters">
            <map>
                <entry key="site-url" value="${site.url}"/>
                <entry key="site-name" value="${site.name}"/>
            </map>
        </property>

        <property name="velocityEngine" ref="velocityEngine"/>

        <property name="mailSender" ref="springMailSender"/>
    </bean>

    <bean id="mailSender" class="wisematches.server.web.mail.impl.ThreadMailSenderImpl" destroy-method="destroy">
        <property name="originalMailSender" ref="defaultMailSender"/>
    </bean>

    <bean id="velocityEngine" class="org.springframework.ui.velocity.VelocityEngineFactoryBean">
        <property name="velocityProperties">
            <props>
                <prop key="resource.loader">class</prop>
                <prop key="class.resource.loader.class">
                    org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader
                </prop>
            </props>
        </property>
    </bean>

    <bean id="rememberTokenDao" class="wisematches.server.web.modules.login.tokens.RememberTokenDao">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="restoreTokenDao" class="wisematches.server.web.modules.login.tokens.RestoreTokenDao">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="problemsReportDao" class="wisematches.server.web.modules.core.problems.ProblemsReportDao">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="playerSettingsDao" class="wisematches.server.web.modules.app.settings.ApplicationSettingsDao">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="sessionCustomHouse" class="wisematches.server.web.server.sessions.WebSessionCustomHouseImpl">
        <property name="loginSessionTimeout" value="300"/>
        <property name="logoutSessionTimeout" value="1800"/>

        <property name="playerManager" ref="playerManager"/>
    </bean>

    <bean id="playerSessionsManager" class="wisematches.server.core.sessions.impl.PlayerSessionsManagerImpl">
        <property name="playerManager" ref="playerManager"/>

        <property name="playerCustomHouses">
            <list>
                <ref bean="sessionCustomHouse"/>
            </list>
        </property>

        <property name="playerSessionBeanInterfaces">
            <list>
                <value>wisematches.server.web.modules.app.sessions.PlayerEventsQueueBean</value>
                <value>wisematches.server.web.modules.app.playboard.PlayerOpenBoardsBean</value>
            </list>
        </property>
    </bean>

    <bean id="memoryWordsDao" class="wisematches.server.web.modules.app.playboard.memory.MemoryWordsDao">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <bean id="playerImagesManager" class="wisematches.server.web.modules.app.images.impl.FilePlayerImagesManager">
        <property name="imagesFolder" value="${server.images.path}/players"/>
    </bean>

    <bean id="gameboardEventProducer"
          class="wisematches.server.web.modules.app.events.producers.GameBoardEventProducer">
        <property name="playerManager" ref="playerManager"/>
        <property name="roomManagerFacade" ref="scribbleRoomManagerFacade"/>
    </bean>

    <bean id="playerEventProducer" class="wisematches.server.web.modules.app.events.producers.PlayerEventProducer">
        <property name="playerStatisticsManager" ref="playerStatisticsManager"/>
        <property name="lockAccountManager" ref="lockAccountManager"/>
    </bean>

    <bean id="projectEventProducer" class="wisematches.server.web.modules.app.events.producers.ProjectEventProducer">
        <property name="ratingsManager" ref="ratingsManager"/>
    </bean>

    <bean id="eventRouter" class="wisematches.server.web.modules.app.events.EventRouter" destroy-method="close">
        <property name="eventEnginesCount" value="1"/>
        <property name="playerSessionsManager" ref="playerSessionsManager"/>

        <property name="eventProducers">
            <list>
                <ref bean="gameboardEventProducer"/>
                <ref bean="playerEventProducer"/>
                <ref bean="projectEventProducer"/>
            </list>
        </property>
    </bean>

    <bean id="notificationsSender" class="wisematches.server.web.modules.app.notification.EMailNotificationsSender"
          destroy-method="destroy">
        <property name="roomsManager" ref="roomsManager"/>
        <property name="mailSender" ref="mailSender"/>
        <property name="playerManager" ref="playerManager"/>
        <property name="gameTimeoutProcessor" ref="gameTimeoutProcessor"/>
        <property name="playerSessionsManager" ref="playerSessionsManager"/>
        <property name="transactionTemplate" ref="transactionTemplateRequiredNew"/>
    </bean>

    <bean id="sessionNotificationBean" class="wisematches.server.web.sessions.SessionNotificationBean">
        <property name="httpSessionListeners">
            <list>
                <bean class="wisematches.server.web.modules.app.sessions.impl.HttpSessionCustomHouse">
                    <property name="sessionCustomHouse" ref="sessionCustomHouse"/>
                </bean>
            </list>
        </property>
    </bean>

    <alias alias="sessionFactory" name="webSessionFactory"/>
</beans>
